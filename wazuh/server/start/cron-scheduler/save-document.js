"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SaveDocument = void 0;

var _getConfiguration = require("../../lib/get-configuration");

var _logger = require("../../lib/logger");

var _indexDate = require("../../lib/index-date");

var _constants = require("../../../common/constants");

var _tryCatchForIndexPermissionError = require("../tryCatchForIndexPermissionError");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class SaveDocument {
  constructor(context) {
    _defineProperty(this, "context", void 0);

    _defineProperty(this, "esClientInternalUser", void 0);

    _defineProperty(this, "logPath", 'cron-scheduler|SaveDocument');

    this.context = context;
    this.esClientInternalUser = context.core.elasticsearch.client.asInternalUser;
  }

  async save(doc, indexConfig) {
    const {
      name,
      creation,
      mapping,
      shards,
      replicas
    } = indexConfig;
    const index = this.addIndexPrefix(name);
    const indexCreation = `${index}-${(0, _indexDate.indexDate)(creation)}`;

    try {
      await this.checkIndexAndCreateIfNotExists(indexCreation, shards, replicas);
      const createDocumentObject = this.createDocument(doc, indexCreation, mapping);
      const response = await this.esClientInternalUser.bulk(createDocumentObject);
      (0, _logger.log)(this.logPath, `Response of create new document ${JSON.stringify(response)}`, 'debug'); // await this.checkIndexPatternAndCreateIfNotExists(index);
    } catch (error) {
      if (error.status === 403) throw {
        error: 403,
        message: `Authorization Exception in the index "${index}"`
      };
      if (error.status === 409) throw {
        error: 409,
        message: `Duplicate index-pattern: ${index}`
      };
      throw error;
    }
  }

  async checkIndexAndCreateIfNotExists(index, shards, replicas) {
    try {
      await (0, _tryCatchForIndexPermissionError.tryCatchForIndexPermissionError)(index)(async () => {
        const exists = await this.esClientInternalUser.indices.exists({
          index
        });
        (0, _logger.log)(this.logPath, `Index '${index}' exists? ${exists.body}`, 'debug');

        if (!exists.body) {
          const response = await this.esClientInternalUser.indices.create({
            index,
            body: {
              settings: {
                index: {
                  number_of_shards: shards || _constants.WAZUH_INDEX_SHARDS,
                  number_of_replicas: replicas || _constants.WAZUH_INDEX_REPLICAS
                }
              }
            }
          });
          (0, _logger.log)(this.logPath, `Status of create a new index: ${JSON.stringify(response)}`, 'debug');
        }
      })();
    } catch (error) {
      (0, _logger.log)(this.logPath, error.message || error);
      this.checkDuplicateIndexError(error);
    }
  }

  checkDuplicateIndexError(error) {
    const {
      type
    } = ((error || {}).body || {}).error || {};
    if (!['resource_already_exists_exception'].includes(type)) throw error;
  }

  createDocument(doc, index, mapping) {
    const createDocumentObject = {
      index,
      type: '_doc',
      body: doc.flatMap(item => [{
        index: {
          _index: index
        }
      }, { ...this.buildData(item, mapping),
        timestamp: new Date(Date.now()).toISOString()
      }])
    };
    (0, _logger.log)(this.logPath, `Document object: ${JSON.stringify(createDocumentObject)}`, 'debug');
    return createDocumentObject;
  }

  buildData(item, mapping) {
    const getItemArray = (array, index) => {
      return JSON.stringify(array[index || 0]);
    };

    const getValue = (key, item) => {
      const keys = key.split('.');

      if (keys.length === 1) {
        if (key.match(/\[.*\]/)) {
          return getItemArray(item[key.replace(/\[.*\]/, '')], key.match(/\[(.*)\]/)[1]);
        }

        return JSON.stringify(item[key]);
      }

      return getValue(keys.slice(1).join('.'), item[keys[0]]);
    };

    if (mapping) {
      let data;
      data = mapping.replace(/\${([a-z|A-Z|0-9|\.\-\_\[.*\]]+)}/gi, (...key) => getValue(key[1], item));
      return JSON.parse(data);
    }

    if (typeof item.data === 'object') {
      return item.data;
    }

    return {
      data: item.data
    };
  }

  addIndexPrefix(index) {
    const configFile = (0, _getConfiguration.getConfiguration)();
    const prefix = configFile['cron.prefix'] || 'wazuh';
    return `${prefix}-${index}`;
  }

}

exports.SaveDocument = SaveDocument;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNhdmUtZG9jdW1lbnQudHMiXSwibmFtZXMiOlsiU2F2ZURvY3VtZW50IiwiY29uc3RydWN0b3IiLCJjb250ZXh0IiwiZXNDbGllbnRJbnRlcm5hbFVzZXIiLCJjb3JlIiwiZWxhc3RpY3NlYXJjaCIsImNsaWVudCIsImFzSW50ZXJuYWxVc2VyIiwic2F2ZSIsImRvYyIsImluZGV4Q29uZmlnIiwibmFtZSIsImNyZWF0aW9uIiwibWFwcGluZyIsInNoYXJkcyIsInJlcGxpY2FzIiwiaW5kZXgiLCJhZGRJbmRleFByZWZpeCIsImluZGV4Q3JlYXRpb24iLCJjaGVja0luZGV4QW5kQ3JlYXRlSWZOb3RFeGlzdHMiLCJjcmVhdGVEb2N1bWVudE9iamVjdCIsImNyZWF0ZURvY3VtZW50IiwicmVzcG9uc2UiLCJidWxrIiwibG9nUGF0aCIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnJvciIsInN0YXR1cyIsIm1lc3NhZ2UiLCJleGlzdHMiLCJpbmRpY2VzIiwiYm9keSIsImNyZWF0ZSIsInNldHRpbmdzIiwibnVtYmVyX29mX3NoYXJkcyIsIldBWlVIX0lOREVYX1NIQVJEUyIsIm51bWJlcl9vZl9yZXBsaWNhcyIsIldBWlVIX0lOREVYX1JFUExJQ0FTIiwiY2hlY2tEdXBsaWNhdGVJbmRleEVycm9yIiwidHlwZSIsImluY2x1ZGVzIiwiZmxhdE1hcCIsIml0ZW0iLCJfaW5kZXgiLCJidWlsZERhdGEiLCJ0aW1lc3RhbXAiLCJEYXRlIiwibm93IiwidG9JU09TdHJpbmciLCJnZXRJdGVtQXJyYXkiLCJhcnJheSIsImdldFZhbHVlIiwia2V5Iiwia2V5cyIsInNwbGl0IiwibGVuZ3RoIiwibWF0Y2giLCJyZXBsYWNlIiwic2xpY2UiLCJqb2luIiwiZGF0YSIsInBhcnNlIiwiY29uZmlnRmlsZSIsInByZWZpeCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBVU8sTUFBTUEsWUFBTixDQUFtQjtBQUt4QkMsRUFBQUEs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QyxLQUFMLENBQVdELElBQVgsQ0FBUDtBQUNEOztBQUVELFFBQUksT0FBT2xCLElBQUksQ0FBQ2tCLElBQVosS0FBcUIsUUFBekIsRUFBbUM7QUFDakMsYUFBT2xCLElBQUksQ0FBQ2tCLElBQVo7QUFDRDs7QUFDRCxXQUFPO0FBQUVBLE1BQUFBLElBQUksRUFBRWxCLElBQUksQ0FBQ2tCO0FBQWIsS0FBUDtBQUNEOztBQUVPNUMsRUFBQUEsY0FBUixDQUF1QkQsS0FBdkIsRUFBc0M7QUFDcEMsVUFBTStDLFVBQVUsR0FBRyx5Q0FBbkI7QUFDQSxVQUFNQyxNQUFNLEdBQUdELFVBQVUsQ0FBQyxhQUFELENBQVYsSUFBNkIsT0FBNUM7QUFDQSxXQUFRLEdBQUVDLE1BQU8sSUFBR2hELEtBQU0sRUFBMUI7QUFDRDs7QUFsSHVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQnVsa0luZGV4RG9jdW1lbnRzUGFyYW1zIH0gZnJvbSAnZWxhc3RpY3NlYXJjaCc7XG5pbXBvcnQgeyBnZXRDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vLi4vbGliL2dldC1jb25maWd1cmF0aW9uJztcbmltcG9ydCB7IGxvZyB9IGZyb20gJy4uLy4uL2xpYi9sb2dnZXInO1xuaW1wb3J0IHsgaW5kZXhEYXRlIH0gZnJvbSAnLi4vLi4vbGliL2luZGV4LWRhdGUnO1xuaW1wb3J0IHsgV0FaVUhfSU5ERVhfU0hBUkRTLCBXQVpVSF9JTkRFWF9SRVBMSUNBUyB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9jb25zdGFudHMnXG5pbXBvcnQgeyB0cnlDYXRjaEZvckluZGV4UGVybWlzc2lvbkVycm9yIH0gZnJvbSAnLi4vdHJ5Q2F0Y2hGb3JJbmRleFBlcm1pc3Npb25FcnJvcidcblxuZXhwb3J0IGludGVyZmFjZSBJSW5kZXhDb25maWd1cmF0aW9uIHtcbiAgbmFtZTogc3RyaW5nXG4gIGNyZWF0aW9uOiAnaCcgfCAnZCcgfCAndycgfCAnbSdcbiAgbWFwcGluZz86IHN0cmluZ1xuICBzaGFyZHM/OiBudW1iZXJcbiAgcmVwbGljYXM/OiBudW1iZXJcbn1cblxuZXhwb3J0IGNsYXNzIFNhdmVEb2N1bWVudCB7XG4gIGNvbnRleHQ6IGFueTtcbiAgZXNDbGllbnRJbnRlcm5hbFVzZXI6IGFueTtcbiAgbG9nUGF0aCA9ICdjcm9uLXNjaGVkdWxlcnxTYXZlRG9jdW1lbnQnO1xuXG4gIGNvbnN0cnVjdG9yKGNvbnRleHQpIHtcbiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuICAgIHRoaXMuZXNDbGllbnRJbnRlcm5hbFVzZXIgPSBjb250ZXh0LmNvcmUuZWxhc3RpY3NlYXJjaC5jbGllbnQuYXNJbnRlcm5hbFVzZXI7XG4gIH1cblxuICBhc3luYyBzYXZlKGRvYzogb2JqZWN0W10sIGluZGV4Q29uZmlnOiBJSW5kZXhDb25maWd1cmF0aW9uKSB7ICAgIFxuICAgIGNvbnN0IHsgbmFtZSwgY3JlYXRpb24sIG1hcHBpbmcsIHNoYXJkcywgcmVwbGljYXMgfSA9IGluZGV4Q29uZmlnO1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5hZGRJbmRleFByZWZpeChuYW1lKTtcbiAgICBjb25zdCBpbmRleENyZWF0aW9uID0gYCR7aW5kZXh9LSR7aW5kZXhEYXRlKGNyZWF0aW9uKX1gO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmNoZWNrSW5kZXhBbmRDcmVhdGVJZk5vdEV4aXN0cyhpbmRleENyZWF0aW9uLCBzaGFyZHMsIHJlcGxpY2FzKTtcbiAgICAgIGNvbnN0IGNyZWF0ZURvY3VtZW50T2JqZWN0ID0gdGhpcy5jcmVhdGVEb2N1bWVudChkb2MsIGluZGV4Q3JlYXRpb24sIG1hcHBpbmcpO1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmVzQ2xpZW50SW50ZXJuYWxVc2VyLmJ1bGsoY3JlYXRlRG9jdW1lbnRPYmplY3QpO1xuICAgICAgbG9nKHRoaXMubG9nUGF0aCwgYFJlc3BvbnNlIG9mIGNyZWF0ZSBuZXcgZG9jdW1lbnQgJHtKU09OLnN0cmluZ2lmeShyZXNwb25zZSl9YCwgJ2RlYnVnJyk7XG4gICAgICAvLyBhd2FpdCB0aGlzLmNoZWNrSW5kZXhQYXR0ZXJuQW5kQ3JlYXRlSWZOb3RFeGlzdHMoaW5kZXgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoZXJyb3Iuc3RhdHVzID09PSA0MDMpXG4gICAgICAgIHRocm93IHsgZXJyb3I6IDQwMywgbWVzc2FnZTogYEF1dGhvcml6YXRpb24gRXhjZXB0aW9uIGluIHRoZSBpbmRleCBcIiR7aW5kZXh9XCJgIH1cbiAgICAgIGlmIChlcnJvci5zdGF0dXMgPT09IDQwOSlcbiAgICAgICAgdGhyb3cgeyBlcnJvcjogNDA5LCBtZXNzYWdlOiBgRHVwbGljYXRlIGluZGV4LXBhdHRlcm46ICR7aW5kZXh9YCB9XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNoZWNrSW5kZXhBbmRDcmVhdGVJZk5vdEV4aXN0cyhpbmRleCwgc2hhcmRzLCByZXBsaWNhcykge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0cnlDYXRjaEZvckluZGV4UGVybWlzc2lvbkVycm9yKGluZGV4KSAoYXN5bmMoKSA9PiB7XG4gICAgICAgIGNvbnN0IGV4aXN0cyA9IGF3YWl0IHRoaXMuZXNDbGllbnRJbnRlcm5hbFVzZXIuaW5kaWNlcy5leGlzdHMoeyBpbmRleCB9KTtcbiAgICAgICAgbG9nKHRoaXMubG9nUGF0aCwgYEluZGV4ICcke2luZGV4fScgZXhpc3RzPyAke2V4aXN0cy5ib2R5fWAsICdkZWJ1ZycpO1xuICAgICAgICBpZiAoIWV4aXN0cy5ib2R5KSB7XG4gICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmVzQ2xpZW50SW50ZXJuYWxVc2VyLmluZGljZXMuY3JlYXRlKHtcbiAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgYm9keToge1xuICAgICAgICAgICAgICBzZXR0aW5nczoge1xuICAgICAgICAgICAgICAgIGluZGV4OiB7XG4gICAgICAgICAgICAgICAgICBudW1iZXJfb2Zfc2hhcmRzOiBzaGFyZHMgfHwgV0FaVUhfSU5ERVhfU0hBUkRTLFxuICAgICAgICAgICAgICAgICAgbnVtYmVyX29mX3JlcGxpY2FzOiByZXBsaWNhcyB8fCBXQVpVSF9JTkRFWF9SRVBMSUNBU1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGxvZyh0aGlzLmxvZ1BhdGgsIGBTdGF0dXMgb2YgY3JlYXRlIGEgbmV3IGluZGV4OiAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlKX1gLCAnZGVidWcnKTtcbiAgICAgICAgfVxuICAgICAgfSkoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nKHRoaXMubG9nUGF0aCwgZXJyb3IubWVzc2FnZSB8fCBlcnJvcik7XG4gICAgICB0aGlzLmNoZWNrRHVwbGljYXRlSW5kZXhFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0R1cGxpY2F0ZUluZGV4RXJyb3IoZXJyb3I6IGFueSkge1xuICAgIGNvbnN0IHsgdHlwZSB9ID0gKChlcnJvciB8fCB7fSkuYm9keSB8fCB7fSkuZXJyb3IgfHwge307XG4gICAgaWYgKCFbJ3Jlc291cmNlX2FscmVhZHlfZXhpc3RzX2V4Y2VwdGlvbiddLmluY2x1ZGVzKHR5cGUpKVxuICAgICAgdGhyb3cgZXJyb3I7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZURvY3VtZW50KGRvYywgaW5kZXgsIG1hcHBpbmc6IHN0cmluZyk6IEJ1bGtJbmRleERvY3VtZW50c1BhcmFtcyB7XG4gICAgY29uc3QgY3JlYXRlRG9jdW1lbnRPYmplY3Q6IEJ1bGtJbmRleERvY3VtZW50c1BhcmFtcyA9IHtcbiAgICAgIGluZGV4LFxuICAgICAgdHlwZTogJ19kb2MnLFxuICAgICAgYm9keTogZG9jLmZsYXRNYXAoaXRlbSA9PiBbe1xuICAgICAgICBpbmRleDogeyBfaW5kZXg6IGluZGV4IH1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIC4uLnRoaXMuYnVpbGREYXRhKGl0ZW0sIG1hcHBpbmcpLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKERhdGUubm93KCkpLnRvSVNPU3RyaW5nKClcbiAgICAgIH1cbiAgICAgIF0pXG4gICAgfTtcbiAgICBsb2codGhpcy5sb2dQYXRoLCBgRG9jdW1lbnQgb2JqZWN0OiAke0pTT04uc3RyaW5naWZ5KGNyZWF0ZURvY3VtZW50T2JqZWN0KX1gLCAnZGVidWcnKTtcbiAgICByZXR1cm4gY3JlYXRlRG9jdW1lbnRPYmplY3Q7XG4gIH1cblxuICBidWlsZERhdGEoaXRlbSwgbWFwcGluZykge1xuICAgIGNvbnN0IGdldEl0ZW1BcnJheSA9IChhcnJheSwgaW5kZXgpID0+IHtcbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShhcnJheVtpbmRleCB8fCAwXSk7XG4gICAgfTtcbiAgICBjb25zdCBnZXRWYWx1ZSA9IChrZXk6IHN0cmluZywgaXRlbSkgPT4ge1xuICAgICAgY29uc3Qga2V5cyA9IGtleS5zcGxpdCgnLicpO1xuICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIGlmKGtleS5tYXRjaCgvXFxbLipcXF0vKSl7XG4gICAgICAgICAgcmV0dXJuIGdldEl0ZW1BcnJheShcbiAgICAgICAgICAgIGl0ZW1ba2V5LnJlcGxhY2UoL1xcWy4qXFxdLywgJycpXSwgXG4gICAgICAgICAgICBrZXkubWF0Y2goL1xcWyguKilcXF0vKVsxXVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGl0ZW1ba2V5XSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZ2V0VmFsdWUoa2V5cy5zbGljZSgxKS5qb2luKCcuJyksIGl0ZW1ba2V5c1swXV0pXG4gICAgfVxuICAgIGlmIChtYXBwaW5nKSB7XG4gICAgICBsZXQgZGF0YTtcbiAgICAgIGRhdGEgPSBtYXBwaW5nLnJlcGxhY2UoXG4gICAgICAgIC9cXCR7KFthLXp8QS1afDAtOXxcXC5cXC1cXF9cXFsuKlxcXV0rKX0vZ2ksXG4gICAgICAgICguLi5rZXkpID0+IGdldFZhbHVlKGtleVsxXSwgaXRlbSlcbiAgICAgIClcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEpO1xuICAgIH1cbiAgICBcbiAgICBpZiAodHlwZW9mIGl0ZW0uZGF0YSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIHJldHVybiBpdGVtLmRhdGE7XG4gICAgfVxuICAgIHJldHVybiB7IGRhdGE6IGl0ZW0uZGF0YSB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRJbmRleFByZWZpeChpbmRleCk6IHN0cmluZyB7XG4gICAgY29uc3QgY29uZmlnRmlsZSA9IGdldENvbmZpZ3VyYXRpb24oKTtcbiAgICBjb25zdCBwcmVmaXggPSBjb25maWdGaWxlWydjcm9uLnByZWZpeCddIHx8ICd3YXp1aCc7XG4gICAgcmV0dXJuIGAke3ByZWZpeH0tJHtpbmRleH1gO1xuICB9XG5cbn0iXX0=