"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.jobSchedulerRun = jobSchedulerRun;

var _index = require("./index");

var _configuredJobs = require("./configured-jobs");

var _logger = require("../../lib/logger");

var _getConfiguration = require("../../lib/get-configuration");

var _nodeCron = _interopRequireDefault(require("node-cron"));

var _constants = require("../../../common/constants");

var _statisticsTemplate = require("../../integration-files/statistics-template");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const blueWazuh = '\u001b[34mwazuh\u001b[39m';
const schedulerErrorLogColors = [blueWazuh, 'scheduler', 'error'];
const schedulerJobs = [];
/**
* Wait until Kibana server is ready
*/

const checkKibanaStatus = async function (context) {
  try {
    (0, _logger.log)('scheduler-handler:checkKibanaStatus', 'Waiting for Kibana and Elasticsearch servers to be ready...', 'debug');
    await checkElasticsearchServer(context);
    await checkTemplate(context);
    return;
  } catch (error) {
    (0, _logger.log)('scheduler-handler:checkKibanaStatus', error.mesage || error);

    try {
      await delay(3000);
      await checkKibanaStatus(context);
    } catch (error) {}

    ;
  }
};
/**
 * Check Elasticsearch Server status and Kibana index presence
 */


const checkElasticsearchServer = async function (context) {
  try {
    const data = await context.core.elasticsearch.client.asInternalUser.indices.exists({
      index: context.server.config.kibana.index
    });
    return data.body;
  } catch (error) {
    (0, _logger.log)('scheduler-handler:checkElasticsearchServer', error.message || error);
    return Promise.reject(error);
  }
};
/**
* Verify wazuh-statistics template
*/


const checkTemplate = async function (context) {
  try {
    (0, _logger.log)('scheduler-handler:checkTemplate', 'Updating the statistics template', 'debug');
    const appConfig = await (0, _getConfiguration.getConfiguration)();
    const prefixTemplateName = appConfig['cron.prefix'] || _constants.WAZUH_STATISTICS_DEFAULT_PREFIX;
    const statisticsIndicesTemplateName = appConfig['cron.statistics.index.name'] || _constants.WAZUH_STATISTICS_DEFAULT_NAME;
    const pattern = `${prefixTemplateName}-${statisticsIndicesTemplateName}-*`;

    try {
      // Check if the template already exists
      const currentTemplate = await context.core.elasticsearch.client.asInternalUser.indices.getTemplate({
        name: _constants.WAZUH_STATISTICS_TEMPLATE_NAME
      }); // Copy already created index patterns

      _statisticsTemplate.statisticsTemplate.index_patterns = currentTemplate.body[_constants.WAZUH_STATISTICS_TEMPLATE_NAME].index_patterns;
    } catch (error) {
      // Init with the default index pattern
      _statisticsTemplate.statisticsTemplate.index_patterns = [pattern];
    } // Check if the user is using a custom pattern and add it to the template if it does


    if (!_statisticsTemplate.statisticsTemplate.index_patterns.includes(pattern)) {
      _statisticsTemplate.statisticsTemplate.index_patterns.push(pattern);
    }

    ; // Update the statistics template

    await context.core.elasticsearch.client.asInternalUser.indices.putTemplate({
      name: _constants.WAZUH_STATISTICS_TEMPLATE_NAME,
      body: _statisticsTemplate.statisticsTemplate
    });
    (0, _logger.log)('scheduler-handler:checkTemplate', 'Updated the statistics template', 'debug');
  } catch (error) {
    const errorMessage = `Something went wrong updating the statistics template ${error.message || error}`;
    (0, _logger.log)('scheduler-handler:checkTemplate', errorMessage);
    context.wazuh.logger.error(schedulerErrorLogColors, errorMessage);
    throw error;
  }
};

async function jobSchedulerRun(context) {
  // Check Kibana index and if it is prepared, start the initialization of Wazuh App.
  await checkKibanaStatus(context);

  for (const job in (0, _configuredJobs.configuredJobs)({})) {
    const schedulerJob = new _index.SchedulerJob(job, context);
    schedulerJobs.push(schedulerJob);

    const task = _nodeCron.default.schedule(_index.jobs[job].interval, () => schedulerJob.run());
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNjaGVkdWxlci1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbImJsdWVXYXp1aCIsInNjaGVkdWxlckVycm9yTG9nQ29sb3JzIiwic2NoZWR1bGVySm9icyIsImNoZWNrS2liYW5hU3RhdHVzIiwiY29udGV4dCIsImNoZWNrRWxhc3RpY3NlYXJjaFNlcnZlciIsImNoZWNrVGVtcGxhdGUiLCJlcnJvciIsIm1lc2FnZSIsImRlbGF5IiwiZGF0YSIsImNvcmUiLCJlbGFzdGljc2VhcmNoIiwiY2xpZW50IiwiYXNJbnRlcm5hbFVzZXIiLCJpbmRpY2VzIiwiZXhpc3RzIiwiaW5kZXgiLCJzZXJ2ZXIiLCJjb25maWciLCJraWJhbmEiLCJib2R5IiwibWVzc2FnZSIsIlByb21pc2UiLCJyZWplY3QiLCJhcHBDb25maWciLCJwcmVmaXhUZW1wbGF0ZU5hbWUiLCJXQVpVSF9TVEFUSVNUSUNTX0RFRkFVTFRfUFJFRklYIiwic3RhdGlzdGljc0luZGljZXNUZW1wbGF0ZU5hbWUiLCJXQVpVSF9TVEFUSVNUSUNTX0RFRkFVTFRfTkFNRSIsInBhdHRlcm4iLCJjdXJyZW50VGVtcGxhdGUiLCJnZXRUZW1wbGF0ZSIsIm5hbWUiLCJXQVpVSF9TVEFUSVNUSUNTX1RFTVBMQVRFX05BTUUiLCJzdGF0aXN0aWNzVGVtcGxhdGUiLCJpbmRleF9wYXR0ZXJucyIsImluY2x1ZGVzIiwicHVzaCIsInB1dFRlbXBsYXRlIiwiZXJyb3JNZXNzYWdlIiwid2F6dWgiLCJsb2dnZXIiLCJqb2JTY2hlZHVsZXJSdW4iLCJqb2IiLCJzY2hlZHVsZXJKb2IiLCJTY2hlZHVsZXJKb2IiLCJ0YXNrIiwiY3JvbiIsInNjaGVkdWxlIiwiam9icyIsImludGVydmFsIiwicnVuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxTQUFTLEdBQUcsMkJBQWxCO0FBQ0EsTUFBTUMsdUJBQXVCLEdBQUcsQ0FBQ0QsU0FBRCxF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QURtRTtBQUV6RWIsTUFBQUEsSUFBSSxFQUFFYztBQUZtRSxLQUFyRSxDQUFOO0FBSUEscUJBQ0UsaUNBREYsRUFFRSxpQ0FGRixFQUdFLE9BSEY7QUFLRCxHQXZDRCxDQXVDRSxPQUFPNUIsS0FBUCxFQUFjO0FBQ2QsVUFBTWlDLFlBQVksR0FBSSx5REFBd0RqQyxLQUFLLENBQUNlLE9BQU4sSUFBaUJmLEtBQU0sRUFBckc7QUFDQSxxQkFDRSxpQ0FERixFQUVFaUMsWUFGRjtBQUlBcEMsSUFBQUEsT0FBTyxDQUFDcUMsS0FBUixDQUFjQyxNQUFkLENBQXFCbkMsS0FBckIsQ0FBMkJOLHVCQUEzQixFQUFvRHVDLFlBQXBEO0FBQ0EsVUFBTWpDLEtBQU47QUFDRDtBQUNGLENBakREOztBQW1ETyxlQUFlb0MsZUFBZixDQUErQnZDLE9BQS9CLEVBQXVDO0FBQzVDO0FBQ0EsUUFBTUQsaUJBQWlCLENBQUNDLE9BQUQsQ0FBdkI7O0FBQ0EsT0FBSyxNQUFNd0MsR0FBWCxJQUFrQixvQ0FBZSxFQUFmLENBQWxCLEVBQXNDO0FBQ3BDLFVBQU1DLFlBQTBCLEdBQUcsSUFBSUMsbUJBQUosQ0FBaUJGLEdBQWpCLEVBQXNCeEMsT0FBdEIsQ0FBbkM7QUFDQUYsSUFBQUEsYUFBYSxDQUFDb0MsSUFBZCxDQUFtQk8sWUFBbkI7O0FBQ0EsVUFBTUUsSUFBSSxHQUFHQyxrQkFBS0MsUUFBTCxDQUNYQyxZQUFLTixHQUFMLEVBQVVPLFFBREMsRUFFWCxNQUFNTixZQUFZLENBQUNPLEdBQWIsRUFGSyxDQUFiO0FBSUQ7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGpvYnMsIFNjaGVkdWxlckpvYiB9IGZyb20gJy4vaW5kZXgnO1xuaW1wb3J0IHsgY29uZmlndXJlZEpvYnMgfSBmcm9tICcuL2NvbmZpZ3VyZWQtam9icyc7XG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLi8uLi9saWIvbG9nZ2VyJztcbmltcG9ydCB7IGdldENvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi8uLi9saWIvZ2V0LWNvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IGNyb24gZnJvbSAnbm9kZS1jcm9uJztcbmltcG9ydCB7IFdBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9QUkVGSVgsIFdBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9OQU1FLCBXQVpVSF9TVEFUSVNUSUNTX1RFTVBMQVRFX05BTUUgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vY29uc3RhbnRzJztcbmltcG9ydCB7IHN0YXRpc3RpY3NUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL2ludGVncmF0aW9uLWZpbGVzL3N0YXRpc3RpY3MtdGVtcGxhdGUnO1xuXG5jb25zdCBibHVlV2F6dWggPSAnXFx1MDAxYlszNG13YXp1aFxcdTAwMWJbMzltJztcbmNvbnN0IHNjaGVkdWxlckVycm9yTG9nQ29sb3JzID0gW2JsdWVXYXp1aCwgJ3NjaGVkdWxlcicsICdlcnJvciddO1xuY29uc3Qgc2NoZWR1bGVySm9icyA9IFtdO1xuXG4vKipcbiogV2FpdCB1bnRpbCBLaWJhbmEgc2VydmVyIGlzIHJlYWR5XG4qL1xuY29uc3QgY2hlY2tLaWJhbmFTdGF0dXMgPSBhc3luYyBmdW5jdGlvbiAoY29udGV4dCkge1xuICB0cnkge1xuICAgICBsb2coXG4gICAgICAgJ3NjaGVkdWxlci1oYW5kbGVyOmNoZWNrS2liYW5hU3RhdHVzJyxcbiAgICAgICAnV2FpdGluZyBmb3IgS2liYW5hIGFuZCBFbGFzdGljc2VhcmNoIHNlcnZlcnMgdG8gYmUgcmVhZHkuLi4nLFxuICAgICAgICdkZWJ1ZydcbiAgICAgKTtcbiBcbiAgICBhd2FpdCBjaGVja0VsYXN0aWNzZWFyY2hTZXJ2ZXIoY29udGV4dCk7XG4gICAgYXdhaXQgY2hlY2tUZW1wbGF0ZShjb250ZXh0KTtcbiAgICByZXR1cm47XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgIGxvZyhcbiAgICAgICAnc2NoZWR1bGVyLWhhbmRsZXI6Y2hlY2tLaWJhbmFTdGF0dXMnLFxuICAgICAgIGVycm9yLm1lc2FnZSB8fGVycm9yXG4gICAgICk7XG4gICAgIHRyeXtcbiAgICAgICBhd2FpdCBkZWxheSgzMDAwKTtcbiAgICAgICBhd2FpdCBjaGVja0tpYmFuYVN0YXR1cyhjb250ZXh0KTtcbiAgICAgfWNhdGNoKGVycm9yKXt9O1xuICB9XG4gfVxuIFxuIFxuIC8qKlxuICAqIENoZWNrIEVsYXN0aWNzZWFyY2ggU2VydmVyIHN0YXR1cyBhbmQgS2liYW5hIGluZGV4IHByZXNlbmNlXG4gICovXG4gY29uc3QgY2hlY2tFbGFzdGljc2VhcmNoU2VydmVyID0gYXN5bmMgZnVuY3Rpb24gKGNvbnRleHQpIHtcbiAgIHRyeSB7XG4gICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBjb250ZXh0LmNvcmUuZWxhc3RpY3NlYXJjaC5jbGllbnQuYXNJbnRlcm5hbFVzZXIuaW5kaWNlcy5leGlzdHMoe1xuICAgICAgIGluZGV4OiBjb250ZXh0LnNlcnZlci5jb25maWcua2liYW5hLmluZGV4XG4gICAgIH0pO1xuIFxuICAgICByZXR1cm4gZGF0YS5ib2R5O1xuICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgbG9nKCdzY2hlZHVsZXItaGFuZGxlcjpjaGVja0VsYXN0aWNzZWFyY2hTZXJ2ZXInLCBlcnJvci5tZXNzYWdlIHx8IGVycm9yKTtcbiAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgIH1cbiB9XG5cblxuIC8qKlxuICogVmVyaWZ5IHdhenVoLXN0YXRpc3RpY3MgdGVtcGxhdGVcbiAqL1xuY29uc3QgY2hlY2tUZW1wbGF0ZSA9IGFzeW5jIGZ1bmN0aW9uIChjb250ZXh0KSB7XG4gIHRyeSB7XG4gICAgbG9nKFxuICAgICAgJ3NjaGVkdWxlci1oYW5kbGVyOmNoZWNrVGVtcGxhdGUnLFxuICAgICAgJ1VwZGF0aW5nIHRoZSBzdGF0aXN0aWNzIHRlbXBsYXRlJyxcbiAgICAgICdkZWJ1ZydcbiAgICApO1xuXG4gICAgY29uc3QgYXBwQ29uZmlnID0gYXdhaXQgZ2V0Q29uZmlndXJhdGlvbigpO1xuICAgIGNvbnN0IHByZWZpeFRlbXBsYXRlTmFtZSA9IGFwcENvbmZpZ1snY3Jvbi5wcmVmaXgnXSB8fCBXQVpVSF9TVEFUSVNUSUNTX0RFRkFVTFRfUFJFRklYO1xuICAgIGNvbnN0IHN0YXRpc3RpY3NJbmRpY2VzVGVtcGxhdGVOYW1lID0gYXBwQ29uZmlnWydjcm9uLnN0YXRpc3RpY3MuaW5kZXgubmFtZSddIHx8IFdBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9OQU1FO1xuICAgIGNvbnN0IHBhdHRlcm4gPSBgJHtwcmVmaXhUZW1wbGF0ZU5hbWV9LSR7c3RhdGlzdGljc0luZGljZXNUZW1wbGF0ZU5hbWV9LSpgO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIHRoZSB0ZW1wbGF0ZSBhbHJlYWR5IGV4aXN0c1xuICAgICAgY29uc3QgY3VycmVudFRlbXBsYXRlID0gYXdhaXQgY29udGV4dC5jb3JlLmVsYXN0aWNzZWFyY2guY2xpZW50LmFzSW50ZXJuYWxVc2VyLmluZGljZXMuZ2V0VGVtcGxhdGUoe1xuICAgICAgICBuYW1lOiBXQVpVSF9TVEFUSVNUSUNTX1RFTVBMQVRFX05BTUVcbiAgICAgIH0pO1xuICAgICAgLy8gQ29weSBhbHJlYWR5IGNyZWF0ZWQgaW5kZXggcGF0dGVybnNcbiAgICAgIHN0YXRpc3RpY3NUZW1wbGF0ZS5pbmRleF9wYXR0ZXJucyA9IGN1cnJlbnRUZW1wbGF0ZS5ib2R5W1dBWlVIX1NUQVRJU1RJQ1NfVEVNUExBVEVfTkFNRV0uaW5kZXhfcGF0dGVybnM7XG4gICAgfWNhdGNoIChlcnJvcikge1xuICAgICAgLy8gSW5pdCB3aXRoIHRoZSBkZWZhdWx0IGluZGV4IHBhdHRlcm5cbiAgICAgIHN0YXRpc3RpY3NUZW1wbGF0ZS5pbmRleF9wYXR0ZXJucyA9IFtwYXR0ZXJuXTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB0aGUgdXNlciBpcyB1c2luZyBhIGN1c3RvbSBwYXR0ZXJuIGFuZCBhZGQgaXQgdG8gdGhlIHRlbXBsYXRlIGlmIGl0IGRvZXNcbiAgICBpZiAoIXN0YXRpc3RpY3NUZW1wbGF0ZS5pbmRleF9wYXR0ZXJucy5pbmNsdWRlcyhwYXR0ZXJuKSkge1xuICAgICAgc3RhdGlzdGljc1RlbXBsYXRlLmluZGV4X3BhdHRlcm5zLnB1c2gocGF0dGVybik7XG4gICAgfTtcblxuICAgIC8vIFVwZGF0ZSB0aGUgc3RhdGlzdGljcyB0ZW1wbGF0ZVxuICAgIGF3YWl0IGNvbnRleHQuY29yZS5lbGFzdGljc2VhcmNoLmNsaWVudC5hc0ludGVybmFsVXNlci5pbmRpY2VzLnB1dFRlbXBsYXRlKHtcbiAgICAgIG5hbWU6IFdBWlVIX1NUQVRJU1RJQ1NfVEVNUExBVEVfTkFNRSxcbiAgICAgIGJvZHk6IHN0YXRpc3RpY3NUZW1wbGF0ZVxuICAgIH0pO1xuICAgIGxvZyhcbiAgICAgICdzY2hlZHVsZXItaGFuZGxlcjpjaGVja1RlbXBsYXRlJyxcbiAgICAgICdVcGRhdGVkIHRoZSBzdGF0aXN0aWNzIHRlbXBsYXRlJyxcbiAgICAgICdkZWJ1ZydcbiAgICApO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBTb21ldGhpbmcgd2VudCB3cm9uZyB1cGRhdGluZyB0aGUgc3RhdGlzdGljcyB0ZW1wbGF0ZSAke2Vycm9yLm1lc3NhZ2UgfHwgZXJyb3J9YDtcbiAgICBsb2coXG4gICAgICAnc2NoZWR1bGVyLWhhbmRsZXI6Y2hlY2tUZW1wbGF0ZScsXG4gICAgICBlcnJvck1lc3NhZ2VcbiAgICApO1xuICAgIGNvbnRleHQud2F6dWgubG9nZ2VyLmVycm9yKHNjaGVkdWxlckVycm9yTG9nQ29sb3JzLCBlcnJvck1lc3NhZ2UpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBqb2JTY2hlZHVsZXJSdW4oY29udGV4dCl7XG4gIC8vIENoZWNrIEtpYmFuYSBpbmRleCBhbmQgaWYgaXQgaXMgcHJlcGFyZWQsIHN0YXJ0IHRoZSBpbml0aWFsaXphdGlvbiBvZiBXYXp1aCBBcHAuXG4gIGF3YWl0IGNoZWNrS2liYW5hU3RhdHVzKGNvbnRleHQpO1xuICBmb3IgKGNvbnN0IGpvYiBpbiBjb25maWd1cmVkSm9icyh7fSkpIHtcbiAgICBjb25zdCBzY2hlZHVsZXJKb2I6IFNjaGVkdWxlckpvYiA9IG5ldyBTY2hlZHVsZXJKb2Ioam9iLCBjb250ZXh0KTtcbiAgICBzY2hlZHVsZXJKb2JzLnB1c2goc2NoZWR1bGVySm9iKTtcbiAgICBjb25zdCB0YXNrID0gY3Jvbi5zY2hlZHVsZShcbiAgICAgIGpvYnNbam9iXS5pbnRlcnZhbCxcbiAgICAgICgpID0+IHNjaGVkdWxlckpvYi5ydW4oKSxcbiAgICApO1xuICB9XG59Il19